<?php
/**
 * @file
 *
 */

/**
 * Implements hook_menu().
 *
 */
function ik_frontend_menu() {
  $items = array();

  $items['channels/%/run'] = array(
    'title' => 'Start slideshow channel',
    'page callback' => 'ik_frontend_run',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['channels/%/update'] = array(
    'title' => 'Request updated slide information',
    'page callback' => 'ik_frontend_update',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['channels/%/slide/%'] = array(
    'title' => 'Request slide information',
    'page callback' => 'ik_frontend_fetch_slide',
    'page arguments' => array(1, 3),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implements hook_theme().
 *
 */
function ik_frontend_theme() {
  return array(
    'ik_frontend_buttons' => array(
      'variables' => array('title' => NULL, 'buttons' => NULL),
      'template' => 'ik-frontend-buttons'
    ),
  );
}

/**
 * Implements hook_ctools_plugin_directory().
 *
 */
function ik_frontend_ctools_plugin_directory($module, $plugin) {
  if ($module == 'ctools' && !empty($plugin)) {
    return "plugins/$plugin";
  }
}

/**
 * Implements hook_node_insert().
 *
 * It's a funny place to have the node hook, but we need this mapping in the
 * front end to fast fetch channels.
 */
function ik_frontend_node_insert($node) {
  $token = ik_channel_filter_token($node->nid);
  $record = array('nid' => $node->nid, 'token' => $token);
  drupal_write_record('ik_channel_mapping', $record);
}

/**
 * Implements hook_node_delete().
 *
 * Make sure that we remove old channel tokens.
 */
function ik_frontend_node_delete($node) {
  db_delete('ik_channel_mapping')->condition('nid', $node->nid)->execute();
}

/**
 * Get channel nid based on channel token mapping.
 *
 * @param string $token
 *  Token representing a given channel.
 * @return int
 *  Channel node id.
 */
function ik_frontend_find_channel_nid($token) {
  $nid = db_select('ik_channel_mapping', 'ikcm')
    ->fields('ikcm', array('nid'))
    ->condition('token', $token)
    ->execute()
    ->fetchCol();
  return $nid[0];
}

/**
 * Helper function that fetches basic information about a channels slides based
 * on the channels filter selections.
 *
 * @param type $entity
 *  Channel node entity.
 * @return array $slides
 *  Array of slides with nid and title for each.
 *
 */
function ik_frontend_get_slides($entity) {
  // Cache ? node update cache ?

  $field = field_info_field('field_channel_preview');
  $field_names = isset($field['settings']['ik_search']['types']) ? $field['settings']['ik_search']['types'] : array();
  $values = array();
  foreach ($field_names as $fieldname) {
    $field = $entity->$fieldname;
    if (!empty($field)) {
      foreach ($field as $lang => $data) {
        $values[$fieldname] = check_plain($data[0]['data']);
      }
    }
  }

  // Get basic slide information based on the filter.
  module_load_include('inc', 'ik_channel_filter', 'ik_channel_filter.queries');
  $slides = ik_channel_filter_get_slides($values);

  return $slides;
}

function ik_frontend_run($token) {

  // Add javascript.

  // Return skeleton for slide show (complet HTML page <header><content><footer> etc.).

  echo 'Requested content for channel: ' . $token;
}


function ik_frontend_update($token) {
  // Find filter values, by loading channel node (cache the result).
  $nid = ik_frontend_find_channel_nid($token);
  $entity = node_load($nid);

  // Get values that shold be used to find slids.
  $slides = ik_frontend_get_slides($entity);

  // JSON encode.
  echo drupal_json_output($slides);
}


function ik_frontend_fetch_slide($token, $sid) {
  // CACHE ?

  // Load slide node content entity_load().
  $entity = node_load($sid);

  // Build slide with information found on the node.
  $slide = new stdClass();
  $silde->sid = $sid;
  $slide->title = check_plain($entity->title);

  $slide->color = '#fff';
  if ($data = field_get_items('node', $entity, 'field_ik_slide_color')) {
    $slide->color = $data[0]['jquery_colorpicker'];
  }

  $slide->logo = '';
  if ($data = field_get_items('node', $entity, 'field_ik_slide_logo')) {
    $slide->logo = file_create_url($data[0]['uri']);
  }

  $slide->media = array();
  if ($data = field_get_items('node', $entity, 'field_ik_slide_media')) {
    foreach ($data as $media) {
      $file = file_load($media['fid']);
      $slide->media[] = file_create_url($file->uri);
    }
  }

  $slide->subheading = '';
  if ($data = field_get_items('node', $entity, 'field_ik_slide_subheading')) {
    $slide->subheading = $data[0]['safe_value'];
  }

  $slide->text = '';
  if ($data = field_get_items('node', $entity, 'field_ik_slide_text')) {
    $slide->text = $data[0]['safe_value'];
  }

  $slide->text_color = '#000';
  if ($data = field_get_items('node', $entity, 'field_ik_slide_text_color')) {
    $slide->text_color = $data[0]['jquery_colorpicker'];
  }

  $slide->exposure = 30;
  if ($data = field_get_items('node', $entity, 'field_ik_slide_exposure')) {
    $slide->exposure = $data[0]['value'];
  }

  $slide->layout = 30;
  if ($data = field_get_items('node', $entity, 'field_layout')) {
    $slide->layout = $data[0]['value'];
  }

  drupal_json_output($slide);
}
